<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ –ú–µ–Ω–µ–¥–∂–µ—Ä –ü–∞—Ä–æ–ª–µ–π</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #1a1a1a;
            margin: 0;
            padding: 30px 0;
            color: #e0e0e0;
        }
        .main-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 25px;
            width: 95%;
            max-width: 1400px;
        }
        .generator-box, .manager-box {
            background-color: #2b2b2b;
            padding: 2.5em;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid #ffcc00;
            box-sizing: border-box;
        }
        .generator-box {
            width: 450px;
            flex-shrink: 0;
        }
        .manager-box {
            flex-grow: 1;
            min-width: 600px;
        }

        h1, h2 {
            font-size: 2.2em;
            color: #ffcc00;
            text-shadow: 0 0 4px #ff6600, 0 0 8px #ff6600;
            margin-bottom: 1.5em;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-align: center;
        }

        .welcome-text {
            color: #c0c0c0;
            text-align: center;
            margin-bottom: 2em;
            font-size: 1.1em;
        }
        .welcome-text strong {
            color: #ffcc00;
        }
        .welcome-text a {
            color: #007bff;
            text-decoration: none;
            transition: color 0.3s;
        }
        .welcome-text a:hover {
            color: #0056b3;
        }

        form label {
            margin-bottom: 0.8em;
            color: #c0c0c0;
            font-size: 1em;
            display: block;
            text-align: left;
        }
        input[type="text"],
        input[type="number"] {
            background-color: #1a1a1a;
            color: #e0e0e0;
            padding: 1em 1.2em;
            border-radius: 8px;
            border: 1px solid #555;
            margin-bottom: 1.5em;
            width: 100%;
            box-sizing: border-box;
            font-size: 1.1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus,
        input[type="number"]:focus {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
            outline: none;
        }
        .checkbox-group {
            margin-bottom: 1.5em;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0.5em;
            font-size: 1em;
            cursor: pointer;
            color: #e0e0e0;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            accent-color: #ffcc00;
            cursor: pointer;
        }
        input[type="submit"] {
            background: linear-gradient(145deg, #007bff, #0056b3);
            color: white;
            padding: 1em 2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.4);
            transition: background 0.3s, box-shadow 0.3s;
            width: 100%;
            margin-top: 1em;
        }
        input[type="submit"]:hover {
            background: linear-gradient(145deg, #0056b3, #004085);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.6);
        }

        .result {
            margin-top: 2.5em;
            padding: 1.5em;
            background-color: #1a1a1a;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #ffcc00;
            word-wrap: break-word;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            border: 1px solid #555;
        }
        .result code {
            display: block;
            margin-top: 0.5em;
            font-size: 1.3em;
            color: #28a745;
        }

        .password-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5em;
            font-size: 0.95em;
            background-color: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
        }
        .password-table th, .password-table td {
            border: 1px solid #444;
            padding: 12px 15px;
            text-align: left;
            color: #e0e0e0;
        }

        /* !!! –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø –î–õ–ò–ù–ù–´–• –ü–ê–†–û–õ–ï–ô !!! */
        .password-table td {
            word-break: break-all; /* –†–∞–∑—Ä–µ—à–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤/—Å—Ç—Ä–æ–∫ */
            max-width: 200px;     /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏, —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å */
            overflow-wrap: break-word; /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
        }

        .password-table th {
            background-color: #3a3a3a;
            color: #ffcc00;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .password-table tbody tr:nth-child(odd) {
            background-color: #2b2b2b;
        }
        .password-table tbody tr:nth-child(even) {
            background-color: #222;
        }
        .password-table td span {
            cursor: pointer;
            text-decoration: underline;
            color: #007bff;
            user-select: all;
        }
        .password-table td span:hover {
            color: #66b3ff;
        }
        .password-table button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #dc3545;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
        }
        .password-table button:hover {
            background-color: #c82333;
            box-shadow: 0 3px 8px rgba(220, 53, 69, 0.5);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid;
        }

        .notification-success {
            background-color: #28a745;
            border-color: #1e7e34;
        }

        .notification-error {
            background-color: #dc3545;
            border-color: #bd2130;
        }
        .notification-info {
            background-color: #007bff;
            border-color: #0056b3;
        }

        @media (max-width: 1100px) {
            .main-container {
                flex-direction: column;
                align-items: center;
            }
            .generator-box, .manager-box {
                width: 90%;
                max-width: 600px;
                flex-shrink: 1;
                min-width: unset;
            }
        }
        @media (max-width: 650px) {
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫—É "–î–∞—Ç–∞" –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
            .password-table th:nth-child(4),
            .password-table td:nth-child(4) {
                display: none;
            }
            .manager-box {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">


        <div class="generator-box">
            <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä üîê</h1>
            <p class="welcome-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <strong>{{ username }}</strong>! (<a href="{{ url_for('logout') }}">–í—ã—Ö–æ–¥</a>)</p>


            <form id="generate-form">
                <label for="site">–°–∞–π—Ç:</label>
                <input type="text" id="site" name="site" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: vk.com" autocomplete="off">

                <label for="login">–õ–æ–≥–∏–Ω (e-mail/–∏–º—è):</label>
                <input type="text" id="login" name="login" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: my_email@example.com" autocomplete="off">

                <label for="length">–î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è (4-128):</label>
                <input type="number" id="length" name="length" value="16" min="4" max="128" required>

                <div class="checkbox-group">
                    <label><input type="checkbox" name="lowercase" id="lowercase" checked> –°—Ç—Ä–æ—á–Ω—ã–µ (a-z)</label>
                    <label><input type="checkbox" name="uppercase" id="uppercase" checked> –ü—Ä–æ–ø–∏—Å–Ω—ã–µ (A-Z)</label>
                    <label><input type="checkbox" name="numbers" id="numbers" checked> –¶–∏—Ñ—Ä—ã (0-9)</label>
                    <label><input type="checkbox" name="symbols" id="symbols" > –°–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã (!@#$%...)</label>
                </div>

                <input type="submit" value="–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –ò –°–û–•–†–ê–ù–ò–¢–¨">
            </form>


            <div class="result" id="password-output">
                <p>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å:</p>
                <code id="generated-password">–ù–∞–∂–º–∏—Ç–µ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"</code>
            </div>
        </div>


        <div class="manager-box">
            <h2>–ú–µ–Ω–µ–¥–∂–µ—Ä –ü–∞—Ä–æ–ª–µ–π</h2>

            <table class="password-table">
                <thead>
                    <tr>
                        <th>–°–∞–π—Ç</th>
                        <th>–õ–æ–≥–∏–Ω</th>
                        <th>–ü–∞—Ä–æ–ª—å</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="password-list-body">
                    <tr><td colspan="5" style="text-align: center; color: #aaa;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <div id="notification-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateForm = document.getElementById('generate-form');
            const generatedPassword = document.getElementById('generated-password');
            const passwordListBody = document.getElementById('password-list-body');

            // --- 1. –ö–∞—Å—Ç–æ–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ---
            function showNotification(message, type = 'info') {
                const existing = document.getElementById('notification-box');
                if (existing) existing.remove();

                const box = document.createElement('div');
                box.id = 'notification-box';
                box.textContent = message;
                box.className = `notification notification-${type}`;

                document.body.appendChild(box);

                setTimeout(() => box.style.opacity = '1', 10);

                setTimeout(() => {
                    box.style.opacity = '0';
                    setTimeout(() => box.remove(), 500);
                }, 4000);
            }

            // --- 2. –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–∞—Ä–æ–ª–µ–π ---
            function loadPasswords() {
                fetch('{{ url_for("passwords") }}')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞—Ä–æ–ª–µ–π.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        passwordListBody.innerHTML = '';
                        const passwords = data.passwords || [];

                        if (passwords.length > 0) {
                            // !!! –ò–°–ü–û–õ–¨–ó–£–ï–ú –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID (pwd.id) –ò–ó –ë–ê–ó–´ –î–ê–ù–ù–´–• !!!
                            passwords.forEach((pwd) => {
                                const row = document.createElement('tr');

                                row.innerHTML = `
                                    <td>${pwd.site || '‚Äî'}</td>
                                    <td>${pwd.login || '‚Äî'}</td>
                                    <td><span title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" onclick="copyToClipboard(event, '${pwd.password}')">${pwd.password}</span></td>
                                    <td>${new Date(pwd.time).toLocaleDateString('ru-RU')}</td>
                                    <td>
                                        <button onclick="deletePassword(${pwd.id})">–£–¥–∞–ª–∏—Ç—å</button>
                                    </td>
                                `;
                                passwordListBody.appendChild(row);
                            });
                        } else {
                            passwordListBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #aaa;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π.</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞—Ä–æ–ª–µ–π:', error);
                        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä–æ–ª–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏ –ë–î.', 'error');
                        passwordListBody.innerHTML = '<tr><td colspan="5" style="color: #dc3545; text-align: center;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä–æ–ª–∏.</td></tr>';
                    });
            }

            // --- 3. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–≥–ª–æ–±–∞–ª—å–Ω–∞—è) ---
            window.copyToClipboard = function(event, text) {
                 event.preventDefault();
                 const el = document.createElement('textarea');
                 el.value = text;
                 el.setAttribute('readonly', '');
                 el.style.position = 'absolute';
                 el.style.left = '-9999px';
                 document.body.appendChild(el);

                 if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        showNotification('–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', 'success');
                        el.remove();
                    }).catch(() => {
                        el.select();
                        try {
                             document.execCommand('copy');
                             showNotification('–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω (Fallback)!', 'success');
                        } catch (err) {
                            showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å. –í—ã–¥–µ–ª–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é.', 'error');
                        } finally {
                            el.remove();
                        }
                    });
                 } else {
                     el.select();
                     try {
                         document.execCommand('copy');
                         showNotification('–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!', 'success');
                     } catch (err) {
                         showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å. –í—ã–¥–µ–ª–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é.', 'error');
                     } finally {
                        el.remove();
                    }
                 }
            }


            // --- 4. –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –¥–ª—è –∫–Ω–æ–ø–∫–∏) ---
            window.deletePassword = function(id) {
                // ID - —ç—Ç–æ Primary Key –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å?')) {
                    fetch('{{ url_for("delete_password") }}', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ id: id }) // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ID –∑–∞–ø–∏—Å–∏ –≤ –ë–î
                    })
                    .then(response => {
                        if (response.ok) {
                            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞
                            loadPasswords();
                            showNotification('–ü–∞—Ä–æ–ª—å —É–¥–∞–ª–µ–Ω.', 'error');
                        } else {
                            response.json().then(err => {
                                showNotification(`–û—à–∏–±–∫–∞: ${err.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.'}`, 'error');
                            }).catch(() => {
                                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è.', 'error');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞:', error);
                        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.', 'error');
                    });
                }
            }


            // --- 5. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ---
            generateForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const form = event.target;
                const lengthValue = parseInt(form.length.value);

                if (lengthValue < 4 || lengthValue > 128 || isNaN(lengthValue)) {
                    showNotification('–î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 4 –¥–æ 128 —Å–∏–º–≤–æ–ª–æ–≤.', 'error');
                    return;
                }

                const data = {
                    length: lengthValue,
                    site: form.site.value,
                    login: form.login.value,
                    lowercase: form.lowercase.checked,
                    uppercase: form.uppercase.checked,
                    numbers: form.numbers.checked,
                    symbols: form.symbols.checked
                };

                if (!data.lowercase && !data.uppercase && !data.numbers && !data.symbols) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
                    return;
                }

                fetch('{{ url_for("generate") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞") });
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.password) {
                        document.getElementById('password-output').querySelector('p').textContent = "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:";
                        generatedPassword.textContent = result.password;

                        showNotification('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');

                        loadPasswords();
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
                    generatedPassword.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                    showNotification(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
                });
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            loadPasswords();
        });
    </script>
</body>
</html>